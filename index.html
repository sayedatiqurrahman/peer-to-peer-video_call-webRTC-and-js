<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AetherLink | Secure P2P Video Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --background: #121212;
    --surface: #1E1E1E;
    --primary: #00A8FF;
    --primary-hover: #0094E0;
    --secondary: #333333;
    --secondary-hover: #444444;
    --text-primary: #EAEAEA;
    --text-secondary: #AAAAAA;
    --border-color: #2D2D2D;
    --glass-bg: rgba(40, 40, 40, 0.6);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--background);
    color: var(--text-primary);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 40px 20px;
    min-height: 100vh;
  }

  .main-container {
    width: 100%;
    max-width: 1200px;
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  header {
    text-align: center;
  }

  header h1 {
    font-size: 2.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  header p {
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }
  
  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }

  .video-card {
    background-color: var(--surface);
    border-radius: 16px;
    padding: 15px;
    border: 1px solid var(--border-color);
    transition: box-shadow 0.3s ease;
  }

  .video-card:hover {
    box-shadow: 0 0 25px rgba(0, 168, 255, 0.1);
  }

  .video-card h2 {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 10px;
    color: var(--text-secondary);
  }

  video {
    width: 100%;
    height: auto;
    border-radius: 10px;
    background-color: #000;
    display: block;
  }

  .controls-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 30px;
    align-items: flex-start;
  }

  .card {
    background-color: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 25px;
  }

  .card h3 {
    font-weight: 500;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
  }

  .button-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .btn {
    font-family: 'Poppins', sans-serif;
    width: 100%;
    padding: 12px 15px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn svg {
    width: 18px;
    height: 18px;
  }

  .btn.primary {
    background-color: var(--primary);
    color: white;
  }

  .btn.primary:hover {
    background-color: var(--primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 168, 255, 0.2);
  }

  .btn.secondary {
    background-color: var(--secondary);
    color: var(--text-primary);
  }

  .btn.secondary:hover {
    background-color: var(--secondary-hover);
  }
  
  .connection-data-area {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  textarea {
    width: 100%;
    height: 140px;
    font-family: monospace;
    background-color: var(--glass-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    padding: 15px;
    resize: none;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-size: 0.9rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 10px rgba(0, 168, 255, 0.3);
  }

  .data-field label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
  }
  
  #connectionStatus {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s ease;
  }

  .status-disconnected {
      background-color: #2a2a2a;
      color: #888;
  }
  .status-connecting {
      background-color: #2c2a00;
      color: #ffeb3b;
  }
  .status-connected {
      background-color: #002d14;
      color: #4caf50;
  }

  @media (max-width: 800px) {
    .controls-grid {
      grid-template-columns: 1fr;
    }
  }

</style>
</head>
<body>

<div class="main-container">
  <header>
    <h1>AetherLink</h1>
    <p>A decentralized, peer-to-peer video communication tool. Share your session data manually to establish a secure, serverless connection.</p>
  </header>

  <div class="video-grid">
    <div class="video-card">
      <h2>Your Video</h2>
      <video id="localVideo" autoplay muted></video>
    </div>
    <div class="video-card">
      <h2>Remote Video</h2>
      <video id="remoteVideo" autoplay></video>
    </div>
  </div>

  <div class="controls-grid">
    <div class="card">
      <h3>Controls</h3>
      <div class="button-group">
        <button id="startBtn" class="btn primary">
          <svg fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 4.354A.5.5 0 0115 4.792V15.208a.5.5 0 01-.447.438l-4-1A.5.5 0 0110 14.5v-9a.5.5 0 01.553-.438l4-1z"></path></svg>
          Start Camera
        </button>
        <button id="createOfferBtn" class="btn secondary">
          <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
          Create Offer
        </button>
        <button id="createAnswerBtn" class="btn secondary">
          <svg fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zm1 4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm0 4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z"></path></svg>
          Create Answer
        </button>
        <button id="addAnswerBtn" class="btn secondary">
          <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
          Add Answer
        </button>
      </div>
      <div id="connectionStatus" class="status-disconnected">
        Status: Disconnected
      </div>
    </div>

    <div class="card connection-data-area">
      <div class="data-field">
        <label for="localSessionDescription">Your Session Data (Copy & Send)</label>
        <textarea title="localSessionDescription" id="localSessionDescription" readonly></textarea>
        <button id="copyLocalBtn" class="btn secondary" style="width: auto; margin-top: 10px; padding: 8px 15px;">Copy</button>
      </div>
      <div class="data-field">
        <label for="remoteSessionDescription">Remote Peer's Session Data (Paste Here)</label>
        <textarea title="remoteSessionDescription" id="remoteSessionDescription"></textarea>
      </div>
    </div>
  </div>

</div>
<script>
// --- Global Variables ---
let pc; // RTCPeerConnection object
let localStream; // Local audio/video stream

// --- DOM Elements ---
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const startBtn = document.getElementById('startBtn');
const createOfferBtn = document.getElementById('createOfferBtn');
const createAnswerBtn = document.getElementById('createAnswerBtn');
const addAnswerBtn = document.getElementById('addAnswerBtn');
const localSessionDescription = document.getElementById('localSessionDescription');
const remoteSessionDescription = document.getElementById('remoteSessionDescription');
const copyLocalBtn = document.getElementById('copyLocalBtn');
const status = document.getElementById("connectionStatus")

// --- Configuration ---
// Using Google's public STUN server to help discover network paths.
const configuration = {
  iceServers: [
    {
      urls: 'stun:stun.l.google.com:19302'
    }
  ]
};

// --- Core Functions ---

// 1. Function to start the peer connection and set up event handlers
function setupPeerConnection() {
  status.innerText = "Status: Disconnected"
  // Create a new RTCPeerConnection. This is the central object for the WebRTC connection.
  pc = new RTCPeerConnection(configuration);

  // Add all tracks from our local stream (audio and video) to the connection.
  // These tracks will be sent to the remote peer.
  localStream.getTracks().forEach(track => {
    pc.addTrack(track, localStream);
  });

  // This event handler is called when a remote track (audio or video) is received.
  pc.ontrack = (event) => {
    console.log("Remote track received:", event.streams[0]);
    // Set the remote video element's source to the received stream.
    remoteVideo.srcObject = event.streams[0];
  };

  // This event handler is called when the browser finds a network path (an ICE candidate).
  // We need to send these candidates to the other peer so they know how to connect to us.
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      // When a candidate is found, the local description (which now includes this candidate)
      // is ready to be sent. We update the textarea.
      console.log("New ICE candidate found. Updating local description.");
      localSessionDescription.value = JSON.stringify(pc.localDescription);
    }
  };

  // Log connection state changes for debugging.
  pc.onconnectionstatechange = () => {
    console.log(`Connection state change: ${pc.connectionState}`);
  };
}

// --- Button Event Handlers ---

// When the "Start Camera + Mic" button is clicked
startBtn.onclick = async () => {
  try {
    // Request access to the user's camera and microphone.
    // The 'await' keyword pauses execution until the user grants or denies permission.
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    // Display the local video stream in the 'localVideo' element.
    localVideo.srcObject = localStream;
    console.log("Local media stream started.");
  } catch (error) {
    // If the user denies permission or an error occurs, show an alert.
    alert("Error getting media devices: " + error.message);
  }
};

// --- OFFERER'S ACTIONS ---

// When the "Create Offer" button is clicked (for the first peer)
createOfferBtn.onclick = async () => {
  if (!localStream) {
    return alert("Please start your camera first!");
  }
  // Initialize the peer connection and set up its event handlers.
  setupPeerConnection();

  // Create an SDP offer. This object contains information about our media capabilities.
  const offer = await pc.createOffer();
  
  // Set this offer as our local description. This starts the ICE gathering process.
  await pc.setLocalDescription(offer);
  
  console.log("Offer created and set as local description.");
  // The onicecandidate handler will now update the textarea as candidates are found.
  alert("Offer is being generated. Copy the text from 'Your Generated Data' and send it to the other peer.");
};


// --- ANSWERER'S ACTIONS ---

// When the "Create Answer" button is clicked (for the second peer)
createAnswerBtn.onclick = async () => {
  if (!localStream) {
    return alert("Please start your camera first!");
  }
  // Initialize the peer connection for the answerer.
  setupPeerConnection();

  try {
    // Get the offer from the remote peer's textarea.
    const remoteOffer = JSON.parse(remoteSessionDescription.value);
    
    // Set the received offer as the remote description.
    await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
    console.log("Remote offer set.");

    // Create an SDP answer based on the offer we received.
    const answer = await pc.createAnswer();
    
    // Set this answer as our local description. This starts ICE gathering for the answerer.
    await pc.setLocalDescription(answer);
    console.log("Answer created and set as local description.");
    alert("Answer is being generated. Copy the text from 'Your Generated Data' and send it back to the offerer.");

  } catch (error) {
    alert("Error creating answer: " + error.message);
    console.error(error);
  }
};


// --- FINAL STEP FOR OFFERER ---

// When the "Add Answer" button is clicked (back on the first peer's side)
addAnswerBtn.onclick = async () => {
  if (!pc) {
    return alert("You must create an offer first!");
  }
  try {
    // Get the answer from the remote peer's textarea.
    const remoteAnswer = JSON.parse(remoteSessionDescription.value);
    
    // Set the received answer as the remote description. This completes the connection.
    await pc.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
    console.log("Remote answer added. Connection should be established.");
    status.innerText = "Status: Connected"
    status.style = {color:"green"}

  } catch (error) {
    alert("Error adding remote answer: " + error.message);
    console.error(error);
  }
};

// --- UTILITY ---
copyLocalBtn.onclick = () => {
  localSessionDescription.select();
  document.execCommand('copy');
  alert("Copied to clipboard!");
};

</script>
</body>
</html